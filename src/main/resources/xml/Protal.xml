<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.accp.dao.ProtalDao">
    <!--配置关键词对象-->
    <resultMap id="keywordMap" type="Keyword">
        <result column="keyword" property="keyword"/>
        <result column="createTime" property="createTime"/>
        <result column="keywordStatus" property="keywordStatus"/>
    </resultMap>

    <!--配置类型对象-->
    <resultMap id="typeMap" type="Type">
        <result column="typeName" property="typeName"/>
    </resultMap>

    <!--配置用户对象-->
    <resultMap id="userMap" type="UserInfo">
        <result column="userName" property="userName"/>
    </resultMap>

    <!--配置客户对象-->
    <resultMap id="custmerMap" type="Customer">
        <result column="companyName" property="companyName"/>
        <!--配置客户下的用户对象-->
        <association resultMap="userMap" property="user"/>
        <!--配置客户下的类型对象-->
        <association resultMap="typeMap" property="type"/>
        <!--配置客户下的关键字对象-->
        <association resultMap="keywordMap" property="keyword"/>
    </resultMap>

    <!--配置门户下的客户信息-->
    <resultMap id="protalMap" type="Protal">
        <result column="protalId" property="protalId"/>
        <result column="legalRepresentative" property="legalRepresentative"/>
        <!--配置门户对应的客户对象-->
        <association resultMap="custmerMap" property="customer"/>
    </resultMap>

    <select id="queryProtalList" resultMap="protalMap">
       SELECT p.protalId,p.legalRepresentative,c.companyName,u.userName,k.keyword,k.createTime,
       (SELECT typeName FROM finance_type WHERE typeid = c.companyType) typeName,k.keywordStatus
       FROM protalinfo p,customerInfo c,userinfo u,keyword k WHERE p.customerId = c.customerId AND
       c.userId = u.userId AND c.customerId = k.customerId
       <if test="keyword != null">
          AND k.keyword LIKE CONCAT ('%',#{keyword},'%')
       </if>
        <if test="customerName != null">
            and c.companyName LIKE CONCAT ('%',#{customerName},'%')
        </if>
        <if test="userId != 0 and userId != 1">
            and u.userId = #{userId}
        </if>
       GROUP BY c.companyName,p.protalId LIMIT #{page.pageNo},#{page.pageSize}
    </select>

    <select id="queryProtalCount" resultType="_Integer">
        SELECT COUNT(1) FROM protalinfo p,customerInfo c,userinfo u,keyword k
        WHERE p.customerId = c.customerId AND c.userId = u.userId AND c.customerId = k.customerId
        <if test="keyword != null">
            AND k.keyword LIKE CONCAT ('%',#{keyword},'%')
        </if>
        <if test="customerName != null">
            AND c.companyName LIKE CONCAT ('%',#{customerName},'%')
        </if>
        <if test="userId != 0 and userId !=1">
            AND c.userId = #{userId}
        </if>
    </select>
</mapper>